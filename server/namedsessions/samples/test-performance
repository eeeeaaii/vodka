v2:~(|begin ~(_import @style-functions_) ~(_import @util-functions_) ~(_bind @justify-doc &" doc size"(|~(_let @newdoc [doc](||)_) ~(_do-for-each &" line"(|~(_let @f ~(_font ~(_light ~(_flatten @line_)_) $"Helvetica"_)_) ~(_set @newdoc ~(_cons ~(_resize-to-target @f @size_) @newdoc_)_)|) @doc_) @newdoc|)_) ~(_bind @resize-to-target &" phrase target"(|~(_let @size ~(_find-best-font @phrase @target_)_) ~(_text-size @phrase @size_)|)_) ~(_bind @do-for-each &" f lst"(|~(|if ~(_is-empty @lst_) [word](__) ~(_cons ~(_@f ~(_car @lst_)_) ~(_do-for-each @f ~(_cdr @lst_)_)_)|)|)_) ~(_bind @range &" start end"(|~(|if ~(_::gt:: @start @end_) [word](__) ~(_cons @start ~(_range ~(_::pl:: @start #1_) @end_)_)|)|)_) ~(_bind @make-width-lookup &" list"(|~(|if ~(_is-empty @list_) [word](__) ~(|begin ~(_let @first ~(_car @list_)_) ~(_let @width ~(_run-js $"$dom[0].getBoundingClientRect().width" @first_)_) ~(_cons ~(_cons @first ~(_cons @width [word](__)_)_) ~(_make-width-lookup ~(_cdr @list_)_)_)|)|)|)_) ~(_bind @lookup &" nex table"(|~(_let @r [nil]_) ~(_do-for-each &" entry"(|~(_let @key ~(_car @entry_)_) ~(|if ~(_equal @key @nex_) ~(_set @r ~(_car ~(_cdr @entry_)_)_) [nil]|)|) @table_) @r|)_) ~(_bind @total-in-font &" phrase font-list-entry"(|~(_let @lookup-table ~(_car ~(_cdr @font-list-entry_)_)_) ~(_let @sum #0_) ~(_do-for-each &" letter"(|~(_let @width ~(_lookup @letter @lookup-table_)_) ~(|if ~(_equal @width [nil]_) [nil] ~(_set @sum ~(_::pl:: @sum @width_)_)|)|) @phrase_) @sum|)_) ~(_bind @calculate-all-widths &" phrase all-lookups"(|~(_do-for-each &" lookup"(|~(_let @font ~(_car @lookup_)_) ~(_let @total ~(_total-in-font @phrase @lookup_)_) ~(_cons @font ~(_cons @total [word](__)_)_)|) @all-lookups_)|)_) ~(_bind @find-best-font &" phrase targetwidth"(|~(_let @widthmap ~(_calculate-all-widths @phrase @lettermap_)_) ~(_let @best ~(_car ~(_car @widthmap_)_)_) ~(_let @find-it &" target prevsize map"(|~(|if ~(_is-empty @map_) @prevsize ~(|begin ~(_let @mapentry ~(_car @map_)_) ~(_let @fontsize ~(_car @mapentry_)_) ~(_let @width-in-font ~(_car ~(_cdr @mapentry_)_)_) ~(|if ~(_::gt:: @width-in-font @target_) @prevsize ~(_find-it @target @fontsize ~(_cdr @map_)_)|)|)|)|)_) ~(_find-it @targetwidth @best @widthmap_)|)_) [doc](|[doc](|[line](_[word](_[letter]"d" [letter]"o"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"e"_) [letter]" " [word](_[letter]"f" [letter]"o" [letter]"l" [letter]"l" [letter]"o" [letter]"w" [letter]"i" [letter]"n" [letter]"g"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"i" [letter]"n" [letter]"g"_) [letter]" " [word](_[letter]"f" [letter]"i" [letter]"r" [letter]"s" [letter]"t"_) [letter]"-" [letter]" " [word](_[letter]"r" [letter]"e" [letter]"t" [letter]"r" [letter]"i" [letter]"e" [letter]"v" [letter]"i" [letter]"n" [letter]"g"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"e"_) [letter]" " [word](_[letter]"f" [letter]"o" [letter]"n" [letter]"t"_) [letter]" " [word](_[letter]"s" [letter]"i" [letter]"z" [letter]"e"_) [letter]" " [word](_[letter]"d" [letter]"o" [letter]"e" [letter]"s" [letter]"n" [letter]"'" [letter]"t"_) [letter]" " [word](_[letter]"w" [letter]"o" [letter]"r" [letter]"k"_) [letter]" " [word](_[letter]"u" [letter]"n" [letter]"t" [letter]"i" [letter]"l"_) [letter]" " [word](_[letter]"i" [letter]"t" [letter]"'" [letter]"s"_) [letter]" " [word](_[letter]"b" [letter]"e" [letter]"e" [letter]"n"_)_) [line](_[nil] [word](_[letter]"r" [letter]"e" [letter]"n" [letter]"d" [letter]"e" [letter]"r" [letter]"e" [letter]"d"_) [letter]" " [word](_[letter]"o" [letter]"n"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"e"_) [letter]" " [word](_[letter]"s" [letter]"c" [letter]"r" [letter]"e" [letter]"e" [letter]"n"_) [letter]" " [letter]" " [letter]"-" [letter]" " [word](_[letter]"l" [letter]"o" [letter]"o" [letter]"k" [letter]"i" [letter]"n" [letter]"g"_) [letter]" " [word](_[letter]"t" [letter]"o"_) [letter]" " [word](_[letter]"f" [letter]"i" [letter]"x"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"i" [letter]"s"_) [letter]"-" [letter]" " [word](_[letter]"t" [letter]"h" [letter]"e" [letter]"n"_) [letter]" " [word](_[letter]"p" [letter]"a" [letter]"s" [letter]"t" [letter]"e"_) [letter]" " [word](_[letter]"i" [letter]"n"_) [letter]" " [word](_[letter]"t" [letter]"h" [letter]"e"_) [letter]" " [word](_[letter]"b" [letter]"i" [letter]"n" [letter]"d"_) [letter]" " [word](_[letter]"e" [letter]"x" [letter]"p" [letter]"r"_) [letter]" " [word](_[letter]"b" [letter]"e" [letter]"l" [letter]"o" [letter]"w"_) [letter]"."_)|) ~(_do-for-each &" n"(|~(_cons @n ~(_cons ~(_font ~(_light ~(_text-size [word](_[letter]"A" [letter]"B" [letter]"C" [letter]"D" [letter]"E" [letter]"F" [letter]"G" [letter]"H" [letter]"I" [letter]"J" [letter]"K" [letter]"L" [letter]"M" [letter]"N" [letter]"O" [letter]"P" [letter]"Q" [letter]"R" [letter]"S" [letter]"T" [letter]"U" [letter]"V" [letter]"W" [letter]"X" [letter]"Y" [letter]"Z" [letter]" " [letter]";" [letter]"," [letter]":" [letter]"?" [letter]"'" [letter]{"} [letter]"." [letter]"," [letter]"a" [letter]"b" [letter]"c" [letter]"d" [letter]"e" [letter]"f" [letter]"g" [letter]"h" [letter]"i" [letter]"j" [letter]"k" [letter]"l" [letter]"m" [letter]"n" [letter]"o" [letter]"p" [letter]"q" [letter]"r" [letter]"s" [letter]"t" [letter]"u" [letter]"v" [letter]"w" [letter]"x" [letter]"y" [letter]"z"_) @n_)_) $"Helvetica"_) [word](__)_)_)|) ~(_range #8 #40_)_) ~(_bind @lettermap ~(_do-for-each &" item"(|~(_let @list ~(_car ~(_cdr @item_)_)_) ~(_let @size ~(_car @item_)_) ~(_cons @size ~(_cons ~(_make-width-lookup @list_) [word](__)_)_)|) [doc](|[line](_[word](_[letter]"i" [letter]"t" [letter]"e" [letter]"m" [letter]"s"_) [letter]" " [word](_[letter]"h" [letter]"e" [letter]"r" [letter]"e"_)_)|)_)_)|)|)